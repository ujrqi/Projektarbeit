<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Display-Konfiguration – 3 Personen (mit RFID)</title>
  <style>
    :root { --gap: 14px; --radius: 14px; --shadow: 0 6px 20px rgba(0,0,0,.08); }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 0; background:#f7f7f9; color:#111; }
    header { padding: 22px; background: white; box-shadow: var(--shadow); position: sticky; top:0; z-index:10; }
    main { max-width: 920px; margin: 24px auto; padding: 0 16px 40px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: var(--gap); align-items: center; }
    .card { background:white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; }
    .grid { display:grid; gap: var(--gap); }
    .people { display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); }
    @media (max-width: 900px){ .people { grid-template-columns: 1fr; } }
    label { display:block; font-size: 13px; color:#555; margin-bottom:6px; }
    input, select { width:100%; box-sizing:border-box; padding:12px 12px; border:1px solid #ddd; border-radius:10px; font-size:15px; outline:none; background:#fff; }
    input:focus, select:focus { border-color:#6f8cff; box-shadow: 0 0 0 3px rgba(111,140,255,.15); }
    button { padding: 11px 14px; border-radius: 10px; border:0; font-weight:600; cursor:pointer; }
    .btn { background:#111; color:white; }
    .btn.secondary { background:#f0f1f4; color:#111; }
    .btn.danger { background:#c62828; color:white; }
    .btn:disabled { opacity:.6; cursor: not-allowed; }
    .muted { color:#666; font-size: 13px; }
    .tag { display:inline-block; padding:5px 9px; border-radius:999px; background:#eef1ff; color:#2b44ff; font-size:12px; font-weight:700; letter-spacing:.2px; }
    .status { min-height: 22px; font-size: 14px; }
    .flex { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row-uid { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; }
    a.btn, a.btn.secondary { display:inline-block; padding: 11px 14px; border-radius: 10px; font-weight:600; text-decoration:none; }
    .row-2col { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end; }
    .btn.icon { padding: 6px 8px; line-height: 1; }
  </style>
</head>
<body>
  <header class="row">
    <div class="flex">
      <strong>Display-Konfiguration</strong>
      <span class="tag">3 Personen</span>
      <!-- <span class="muted">Verwendet <code>/api/state</code> und <code>/api/read_tag</code> des ESP32</span> -->
    </div>
    <div class="flex">
      <a class="btn secondary" href="/">← Zur Startseite</a>
      <input id="baseUrl" placeholder="IP-Adresse oder z.B. display1.local" aria-label="Geräte-URL" style="width:280px" />
      <button class="btn secondary" id="btnPing">Ping</button>
      <button class="btn secondary" id="btnLoad">Laden</button>
      <button class="btn" id="btnSaveAll">Alles speichern</button>
    </div>
  </header>

  <main class="grid" style="gap: 18px;">
    <div class="card grid">
      <!-- Kopfstatus -->
      <div class="row">
        <div class="flex">
          <div>
            <div class="muted">Raum (aktuell)</div>
            <div class="flex" style="gap:6px; align-items:center">
              <div id="roomText" style="font-weight:700">—</div>
              <button class="btn secondary icon" id="btnRoomEdit" title="Raum bearbeiten" aria-label="Raum bearbeiten">✎</button>
            </div>
          </div>
          <div style="width:16px"></div>
          <div>
            <div class="muted">Layout</div>
            <div id="layoutText" style="font-weight:700">—</div>
          </div>
        </div>
        <div class="status" id="globalStatus"></div>
      </div>

      <!-- Raum editing panel -->
      <div id="roomPanel" class="grid" style="display:none;">
        <div>
          <label for="roomSelect">Raum wählen</label>
          <div class="row-2col">
            <select id="roomSelect"></select>
            <button class="btn secondary" id="btnSaveRoom">Raum speichern</button>
          </div>
          <div id="roomAddBox" class="row-2col" style="margin-top:10px; display:none;">
            <input id="roomAddInput" placeholder="Neuen Raum eingeben, z. B. 324A" />
            <button class="btn" id="btnAddRoom">Hinzufügen</button>
          </div>
          <div id="roomRemoveBox" class="row-2col" style="margin-top:10px; display:none;">
            <select id="roomRemoveSelect"></select>
            <button class="btn danger" id="btnRemoveRoom">Entfernen</button>
          </div>
        </div>
      </div>

      <!-- Personen -->
      <div class="people">
        <!-- Person 0 -->
        <div class="card grid">
          <div class="muted">Person 1</div>
          <div>
            <label for="p0_name">Name</label>
            <input id="p0_name" placeholder="" />
          </div>
          <div>
            <label for="p0_role">Rolle</label>
            <input id="p0_role" placeholder="" />
          </div>
          <div>
            <label for="p0_uid">RFID-Tag (UID)</label>
            <div class="row-uid">
              <input id="p0_uid" placeholder="z. B. 04A1B2C3D4" />
              <button class="btn secondary" id="p0_read">Lesen</button>
            </div>
            <div class="muted">Tipp: Halte den Tag an den Leser.</div>
          </div>

          <!-- New: Status -->
          <div>
            <label for="p0_statusSel">Status</label>
            <div class="row-uid">
              <select id="p0_statusSel">
                <option value="">— Status wählen —</option>
                <option value="On Vacation">On Vacation</option>
                <option value="In a Meeting">In a Meeting</option>
                <option value="Out of Office">Out of Office</option>
              </select>
              <button class="btn danger" id="p0_statusClear" style="display:none">entfernen</button>
            </div>
            <div class="muted">Check-in/Check-out wird temporell deaktiviert.</div>
          </div>
          <div class="flex">
            <button class="btn" id="p0_save">Person speichern</button>
            <button class="btn danger" id="p0_remove" style="display:none">Person entfernen</button>
            <span class="status" id="p0_status"></span>
          </div>
        </div>

        <!-- Person 1 -->
        <div class="card grid">
          <div class="muted">Person 2</div>
          <div>
            <label for="p1_name">Name</label>
            <input id="p1_name" placeholder=""  />
          </div>
          <div>
            <label for="p1_role">Rolle</label>
            <input id="p1_role" placeholder="" />
          </div>
          <div>
            <label for="p1_uid">RFID-Tag (UID)</label>
            <div class="row-uid">
              <input id="p1_uid" placeholder="z. B. 04A1B2C3D4" />
              <button class="btn secondary" id="p1_read">Lesen</button>
            </div>
            <div class="muted">Tipp: Halte den Tag an den Leser.</div>
          </div>

          <!-- New: Status -->
          <div>
            <label for="p1_statusSel">Status</label>
            <div class="row-uid">
              <select id="p1_statusSel">
                <option value="">— Status wählen —</option>
                <option value="On Vacation">On Vacation</option>
                <option value="In a Meeting">In a Meeting</option>
                <option value="Out of Office">Out of Office</option>
              </select>
              <button class="btn danger" id="p1_statusClear" style="display:none">entfernen</button>
            </div>
            <div class="muted">Check-in/Check-out wird temporell deaktiviert.</div>
          </div>

          <div class="flex">
            <button class="btn" id="p1_save">Person speichern</button>
            <button class="btn danger" id="p1_remove" style="display:none">Person entfernen</button>
            <span class="status" id="p1_status"></span>
          </div>
        </div>

        <!-- Person 2 -->
        <div class="card grid">
          <div class="muted">Person 3</div>
          <div>
            <label for="p2_name">Name</label>
            <input id="p2_name" placeholder="" />
          </div>
          <div>
            <label for="p2_role">Rolle</label>
            <input id="p2_role" placeholder="" />
          </div>
          <div>
            <label for="p2_uid">RFID-Tag (UID)</label>
            <div class="row-uid">
              <input id="p2_uid" placeholder="z. B. 04A1B2C3D4" />
              <button class="btn secondary" id="p2_read">Lesen</button>
            </div>
               <div class="muted">Tipp: Halte den Tag an den Leser.</div>
          </div>

          <!-- New: Status -->
          <div>
            <label for="p2_statusSel">Status</label>
            <div class="row-uid">
              <select id="p2_statusSel">
                <option value="">— Status wählen —</option>
                <option value="On Vacation">On Vacation</option>
                <option value="In a Meeting">In a Meeting</option>
                <option value="Out of Office">Out of Office</option>
              </select>
              <button class="btn danger" id="p2_statusClear" style="display:none">entfernen</button>
            </div>
            <div class="muted">Check-in/Check-out wird temporell deaktiviert.</div>
          </div>

          <div class="flex">
            <button class="btn" id="p2_save">Person speichern</button>
            <button class="btn danger" id="p2_remove" style="display:none">Person entfernen</button>
            <span class="status" id="p2_status"></span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    // —— Rooms (localStorage)
    const DEFAULT_ROOMS = ["324","325","326","327","328"];
    function loadRooms(){ try{ const s=localStorage.getItem("rooms"); const a=s?JSON.parse(s):DEFAULT_ROOMS.slice(); return Array.isArray(a)&&a.length?a.map(String):DEFAULT_ROOMS.slice(); }catch{ return DEFAULT_ROOMS.slice(); } }
    function saveRooms(a){ try{ localStorage.setItem("rooms", JSON.stringify(a)); }catch{} }

    // —— Special STATUS die RFID blockieren
    const OVERRIDE_STATUSES = new Set(["On Vacation","In a Meeting","Out of Office"]);
    const isOverride = s => OVERRIDE_STATUSES.has(String(s||""));

    const els = {
      baseUrl: $("baseUrl"),
      btnPing: $("btnPing"),
      btnLoad: $("btnLoad"),
      btnSaveAll: $("btnSaveAll"),
      roomText: $("roomText"),
      layoutText: $("layoutText"),
      globalStatus: $("globalStatus"),

      btnRoomEdit: $("btnRoomEdit"),
      roomPanel: $("roomPanel"),

      roomSelect: $("roomSelect"),
      btnSaveRoom: $("btnSaveRoom"),
      roomAddBox: $("roomAddBox"),
      roomAddInput: $("roomAddInput"),
      btnAddRoom: $("btnAddRoom"),
      roomRemoveBox: $("roomRemoveBox"),
      roomRemoveSelect: $("roomRemoveSelect"),
      btnRemoveRoom: $("btnRemoveRoom"),

      p: [
        { name: $("p0_name"), role: $("p0_role"), uid: $("p0_uid"), read: $("p0_read"), save: $("p0_save"), remove: $("p0_remove"), status: $("p0_status"), statusSel: $("p0_statusSel"), statusClear: $("p0_statusClear") },
        { name: $("p1_name"), role: $("p1_role"), uid: $("p1_uid"), read: $("p1_read"), save: $("p1_save"), remove: $("p1_remove"), status: $("p1_status"), statusSel: $("p1_statusSel"), statusClear: $("p1_statusClear") },
        { name: $("p2_name"), role: $("p2_role"), uid: $("p2_uid"), read: $("p2_read"), save: $("p2_save"), remove: $("p2_remove"), status: $("p2_status"), statusSel: $("p2_statusSel"), statusClear: $("p2_statusClear") },
      ]
    };

    let currentState = null; // { room, layout, people:[{name,role,status,uid}] }
    let rooms = loadRooms();

    function setBusy(busy){
      els.btnPing.disabled = busy;
      els.btnLoad.disabled = busy;
      els.btnSaveAll.disabled = busy;
      els.btnSaveRoom.disabled = busy;
      els.btnAddRoom.disabled = busy;
      els.btnRemoveRoom.disabled = busy;
      els.p.forEach(p => {
        p.save.disabled = busy || p.save.style.display === 'none';
        p.remove.disabled = busy || p.remove.style.display === 'none';
        p.read.disabled = busy
         || isOverride(p.statusSel.value)
         || (p.read.style.display === 'none')
         || (p.name.dataset.locked === 'true');
        p.name.disabled = p.name.dataset.locked === 'true' || (busy && p.name.disabled);
        p.role.disabled = p.role.dataset.locked === 'true' || (busy && p.role.disabled);
        p.uid.disabled  = p.uid.dataset.locked  === 'true' || (busy && p.uid.disabled);
        p.statusSel.disabled = busy ? true : false;
        p.statusClear.disabled = busy ? true : false;
      });
    }

    function showGlobal(msg, ok=true){ els.globalStatus.textContent = msg||""; els.globalStatus.style.color = ok ? "green" : "#b00020"; }
    function showRow(i, msg, ok=true){ els.p[i].status.textContent = msg||""; els.p[i].status.style.color = ok ? "green" : "#b00020"; }

    function normalizeBase(u){ u=(u||"").trim(); if(!u) return ""; if(!/^https?:\/\//i.test(u)) u="http://"+u; return u.replace(/\/+$/,""); }
    function url(path){ return normalizeBase(els.baseUrl.value)+path; }

    function personExists(person){ return !!(person?.name || person?.role || person?.uid); }

    function setPersonMode(i, mode){
      const row = els.p[i];
      const locked = mode === 'locked';
      row.name.disabled = locked;
      row.role.disabled = locked;
      row.uid.disabled  = locked;
      row.name.dataset.locked = String(locked);
      row.role.dataset.locked = String(locked);
      row.uid.dataset.locked  = String(locked);

      row.save.style.display   = locked ? 'none' : 'inline-block';
      row.read.style.display   = locked ? 'none' : 'inline-block';
      row.remove.style.display = locked ? 'inline-block' : 'none';
      // Status control is ALWAYS enabled.
    }

    // —— Room select (with special options)
    const ROOM_ADD_VALUE = "__add__";
    const ROOM_REMOVE_VALUE = "__remove__";

    function renderRoomSelect(selectedRoom){
      const sel = els.roomSelect; sel.innerHTML="";
      rooms.forEach(r => { const o=document.createElement("option"); o.value=r; o.textContent=r; sel.appendChild(o); });
      const oSep=document.createElement("option"); oSep.disabled=true; oSep.textContent="──────────"; sel.appendChild(oSep);
      const oAdd=document.createElement("option"); oAdd.value=ROOM_ADD_VALUE; oAdd.textContent="Raum hinzufügen…"; sel.appendChild(oAdd);
      const oRem=document.createElement("option"); oRem.value=ROOM_REMOVE_VALUE; oRem.textContent="Raum entfernen…"; sel.appendChild(oRem);

      if (selectedRoom){
        if(!rooms.includes(selectedRoom)){ rooms.push(selectedRoom); rooms=[...new Set(rooms)].sort(); saveRooms(rooms); return renderRoomSelect(selectedRoom); }
        sel.value=selectedRoom;
      } else if (rooms.length){ sel.value=rooms[0]; }

      renderRoomRemoveSelect();
    }

    function renderRoomRemoveSelect(){
      const sel=els.roomRemoveSelect; sel.innerHTML="";
      rooms.forEach(r => { const o=document.createElement("option"); o.value=r; o.textContent=r; sel.appendChild(o); });
      if(!rooms.length){ const o=document.createElement("option"); o.textContent="—"; sel.appendChild(o); }
    }

    function populateUI(state){
      els.roomText.textContent = state.room ?? '—';
      els.layoutText.textContent = String(state.layout ?? '—');
      renderRoomSelect(state.room || rooms[0]);

      for (let i=0;i<3;i++){
        const person = state.people?.[i] || {name:'', role:'', uid:'', status:''};
        els.p[i].name.value = person.name || '';
        els.p[i].role.value = person.role || '';
        els.p[i].uid.value  = (person.uid || '').toUpperCase();

        // Status UI
        const hasOv = isOverride(person.status);
        els.p[i].statusSel.value = hasOv ? person.status : "";

        if (personExists(person)) setPersonMode(i, 'locked'); 
        else setPersonMode(i, 'empty');
        els.p[i].statusClear.style.display = hasOv ? "inline-block" : "none";

        refreshRowInteractivity(i);
      }
    }

    // —— API
    async function fetchPing(){ const r=await fetch(url('/api/ping')); if(!r.ok) throw new Error(r.status); return r.json(); }
    async function fetchState(){ const r=await fetch(url('/api/state')); if(!r.ok) throw new Error(r.status); return r.json(); }
    async function postState(state){
      const r = await fetch(url('/api/state'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(state) });
      if(!r.ok) throw new Error(r.status); return r.json();
    }
    async function fetchReadTag(timeoutMs=8000){
      const ctl=new AbortController(); const to=setTimeout(()=>ctl.abort(), timeoutMs+500);
      try{ const r=await fetch(url('/api/read_tag'), { signal: ctl.signal }); if(r.status===204) return null; if(!r.ok) throw new Error(r.status); return r.json(); }
      finally{ clearTimeout(to); }
    }

    // —— Build helpers
    function buildPeopleFromUI(){
      const arr=[];
      for(let i=0;i<3;i++){
        const name=els.p[i].name.value.trim();
        const role=els.p[i].role.value.trim();
        const uid =els.p[i].uid.value.trim().toUpperCase();
        const st  =els.p[i].statusSel.value;
        const o={ name, role, uid };
        if (isOverride(st)) o.status = st; // Only sends statuses if they are special.
        if (name || role || uid || o.status) arr.push(o);
      }
      return arr;
    }
    function getSelectedRoom(){
      const val=els.roomSelect.value;
      if (val && val!=="__add__" && val!=="__remove__") return val;
      return els.roomText.textContent || "";
    }
    function refreshRowInteractivity(i){
      const row = els.p[i];
      const locked = row.name.dataset.locked === 'true';
      const overr  = isOverride(row.statusSel.value);
    // Enable/disable “Lesen” ONLY under actual current conditions
      row.read.disabled = overr || locked || (row.read.style.display === 'none');
}

    // —— General saves
    async function handleSaveAll(){
      setBusy(true); showGlobal('Speichere…', true);
      try{
        const updated={ room:getSelectedRoom(), people:buildPeopleFromUI() };
        await postState(updated);
        currentState=await fetchState();
        populateUI(currentState);
        showGlobal('Gespeichert und neu geladen ✔️', true);
      }catch(err){ console.error(err); showGlobal('Konnte nicht speichern. Verbindung/CORS prüfen.', false); }
      finally{ setBusy(false); }
    }
    async function handleSaveOne(i){
      setBusy(true); showRow(i,'Speichere…', true);
      try{
        const updated={ room:getSelectedRoom(), people:buildPeopleFromUI() };
        await postState(updated);
        currentState=await fetchState();
        populateUI(currentState);
        showRow(i,'OK ✔️', true);
      }catch(err){ console.error(err); showRow(i,'Fehler beim Speichern', false); }
      finally{ setBusy(false); }
    }

    // —— Remove person (maintains your logic)
    async function handleRemove(i){
      setBusy(true); showRow(i,'Entferne…', true);
      try{
        const next=[];
        for(let j=0;j<3;j++){
          if(j===i) continue;
          const p=currentState?.people?.[j];
          if(p && (p.name||p.role||p.uid)){
            const o={ name:p.name||'', role:p.role||'', uid:(p.uid||'').toUpperCase() };
            if (isOverride(p.status)) o.status=p.status;
            next.push(o);
          }
        }
        await postState({ room:getSelectedRoom(), people:next });
        currentState=await fetchState();
        populateUI(currentState);
        showRow(i,'Entfernt ✔️', true);
      }catch(err){ console.error(err); showRow(i,'Fehler beim Entfernen', false); }
      finally{ setBusy(false); }
    }

    // —— RFID reading (disabled if there is an override)
    async function handleRead(i){
      if (isOverride(els.p[i].statusSel.value)) { showRow(i,'Status aktiv – RFID deaktiviert', false); return; }
      setBusy(true); showRow(i,'Warte auf Tag… (max. 8 s)', true);
      try{
        const j=await fetchReadTag(8000);
        if(j?.uid){ els.p[i].uid.value=j.uid.toUpperCase(); showRow(i,'Tag gelesen ✔️', true); }
        else{ showRow(i,'Kein Tag gelesen', false); }
      }catch(err){ console.error(err); showRow(i,'Fehler beim Lesen des Tags', false); }
      finally{ setBusy(false); }
    }

    // —— Status: set and clear (immediate auto-save)
    async function postPeopleUpdateWithStatus(i, statusVal){
      // we build from the current state so as not to lose blocked people
      const next=[];
      for(let j=0;j<3;j++){
        const name = (els.p[j].name.value||"").trim();
        const role = (els.p[j].role.value||"").trim();
        const uid  = (els.p[j].uid.value||"").trim().toUpperCase();
        const o={ name, role, uid };
        if (j===i) { o.status = statusVal; }
        else {
          const pj = currentState?.people?.[j];
          if (isOverride(pj?.status)) o.status = pj.status;
        }
        if (o.name || o.role || o.uid || o.status) next.push(o);
      }
      await postState({ room:getSelectedRoom(), people:next });
      currentState = await fetchState();
      populateUI(currentState);
    }

    async function handleStatusChange(i){
    const v = els.p[i].statusSel.value;
    if (isOverride(v)){
    els.p[i].statusClear.style.display = 'inline-block';
    refreshRowInteractivity(i); // Disables “Lesen” by override
    showRow(i,'Status setzen…', true);
    try{
      await postPeopleUpdateWithStatus(i, v);
      showRow(i,'Status gesetzt ✔️', true);
    }catch(err){ console.error(err); showRow(i,'Fehler beim Setzen', false); }
  } 
    else {
    els.p[i].statusClear.style.display = 'none';
    refreshRowInteractivity(i); // reevaluate: no override -> can be enabled
  }
}


   async function handleStatusClear(i){
  showRow(i,'Status entfernen…', true);
  try{
    els.p[i].statusSel.value = "";
    els.p[i].statusClear.style.display = 'none';
    refreshRowInteractivity(i); // Reactivate “Lesen” in the local UI
    await postPeopleUpdateWithStatus(i, "Absent");
    showRow(i,'Status entfernt ✔️', true);
  }catch(err){ console.error(err); showRow(i,'Fehler beim Entfernen', false); }
}


    // —— Ping/Load/Room handlers
    async function handlePing(){ setBusy(true); showGlobal('Ping läuft…', true);
      try{ await fetchPing(); showGlobal('Ping OK ✔️', true); }
      catch(err){ console.error(err); showGlobal('Ping fehlgeschlagen. IP/mDNS prüfen und ESP32 einschalten.', false); }
      finally{ setBusy(false); } }

    async function handleLoad(){ setBusy(true); showGlobal('Lade…', true);
      try{
        currentState=await fetchState();
        if(currentState.room && !rooms.includes(currentState.room)){ rooms.push(currentState.room); rooms=[...new Set(rooms)].sort(); saveRooms(rooms); }
        populateUI(currentState); showGlobal('Fertig ✔️', true);
      }catch(err){ console.error(err); showGlobal('Fehler beim Laden. URL/IP prüfen und ESP32 verbinden.', false); }
      finally{ setBusy(false); } }

    async function handleSaveRoom(){
      const val=getSelectedRoom(); if(!val){ showGlobal('Kein Raum ausgewählt.', false); return; }
      setBusy(true); showGlobal('Raum speichern…', true);
      try{ await postState({ room:val }); currentState=await fetchState(); populateUI(currentState); showGlobal('Raum gespeichert ✔️', true); }
      catch(err){ console.error(err); showGlobal('Konnte Raum nicht speichern.', false); }
      finally{ setBusy(false); }
    }

    function handleRoomSelectChange(){
      const val=els.roomSelect.value;
      els.roomAddBox.style.display    = (val==="__add__")    ? 'grid' : 'none';
      els.roomRemoveBox.style.display = (val==="__remove__") ? 'grid' : 'none';
    }
    function handleAddRoom(){
      const v=(els.roomAddInput.value||'').trim(); if(!v) return;
      if(!rooms.includes(v)){ rooms.push(v); rooms=[...new Set(rooms)].sort(); saveRooms(rooms); }
      els.roomAddInput.value=''; els.roomAddBox.style.display='none';
      renderRoomSelect(v); els.roomText.textContent=v;
    }
    function handleRemoveRoom(){
      const val=els.roomRemoveSelect.value; if(!val) return;
      if(rooms.length<=1){ showGlobal('Mindestens ein Raum muss vorhanden sein.', false); return; }
      const currentSelected=els.roomSelect.value;
      rooms=rooms.filter(r=>r!==val); saveRooms(rooms);
      const nextSelected=rooms.includes(currentSelected)?currentSelected:(rooms[0]||"");
      renderRoomSelect(nextSelected); els.roomRemoveBox.style.display='none';
      showGlobal(`Raum „${val}“ entfernt.`, true);
    }
    function toggleRoomPanel(){ els.roomPanel.style.display = (els.roomPanel.style.display==='none'||!els.roomPanel.style.display)?'grid':'none'; }

    // Wire-up
    els.btnRoomEdit.addEventListener('click', toggleRoomPanel);

    els.btnPing.addEventListener('click', handlePing);
    els.btnLoad.addEventListener('click', handleLoad);
    els.btnSaveAll.addEventListener('click', handleSaveAll);

    els.p[0].save.addEventListener('click', () => handleSaveOne(0));
    els.p[1].save.addEventListener('click', () => handleSaveOne(1));
    els.p[2].save.addEventListener('click', () => handleSaveOne(2));

    els.p[0].remove.addEventListener('click', () => handleRemove(0));
    els.p[1].remove.addEventListener('click', () => handleRemove(1));
    els.p[2].remove.addEventListener('click', () => handleRemove(2));

    els.p[0].read.addEventListener('click', () => handleRead(0));
    els.p[1].read.addEventListener('click', () => handleRead(1));
    els.p[2].read.addEventListener('click', () => handleRead(2));

    els.p[0].statusSel.addEventListener('change', () => handleStatusChange(0));
    els.p[1].statusSel.addEventListener('change', () => handleStatusChange(1));
    els.p[2].statusSel.addEventListener('change', () => handleStatusChange(2));

    els.p[0].statusClear.addEventListener('click', () => handleStatusClear(0));
    els.p[1].statusClear.addEventListener('click', () => handleStatusClear(1));
    els.p[2].statusClear.addEventListener('click', () => handleStatusClear(2));

    els.roomSelect.addEventListener('change', handleRoomSelectChange);
    els.btnAddRoom.addEventListener('click', handleAddRoom);
    els.btnSaveRoom.addEventListener('click', handleSaveRoom);
    els.btnRemoveRoom.addEventListener('click', handleRemoveRoom);

    // Initial render
    renderRoomSelect();
  </script>
</body>
</html>
